local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
local VirtualInputManager = game:GetService("VirtualInputManager")

-- // 1. UI SETUP // --
local Window = WindUI:CreateWindow({
    Title = "RaZui Hub",
    Folder = "MySuperHub",
    Size = UDim2.fromOffset(580, 460),
    MinSize = Vector2.new(560, 350),
    MaxSize = Vector2.new(850, 560),
    Transparent = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 150,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = false,
})

Window:SetToggleKey(Enum.KeyCode.K)
Window:EditOpenButton({
    Title = "Open UI",
    CornerRadius = UDim.new(0,16),
    StrokeThickness = 2,
    Color = ColorSequence.new(Color3.fromHex("FF0F7B"), Color3.fromHex("F89B29")),
    OnlyMobile = false,
    Enabled = true,
    Draggable = true,
})

local CombatTab = Window:Tab({ Title = "Combat", Icon = "rbxassetid://10723345518" })
local MiscTab = Window:Tab({ Title = "Misc", Icon = "rbxassetid://10723424505" }) 

CombatTab:Select()

-- // 2. SERVICES & CONFIG // --

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local NetworkComm = ReplicatedStorage:WaitForChild("NetworkComm")

-- Services
local SkillService = NetworkComm:WaitForChild("SkillService")
local CombatService = NetworkComm:WaitForChild("CombatService")
local MapService = NetworkComm:WaitForChild("MapService")

local StartSkillMethod = SkillService:WaitForChild("StartSkilll_Method")
local DamageMethod = CombatService:WaitForChild("DamageCharacter_Method")
local CrateRemote = MapService:WaitForChild("OpenExplorationCrate_Method")

-- Variables
local AuraEnabled = false
local UnlockTPEnabled = false
local AutoCrateEnabled = false
local CrateConnection = nil

-- Configuration (Matched to your snippet)
local CONFIG = {
    Range = 25,           -- Range in studs
    HitDelay = 0.35,      -- Delay between attacks
    RegisterDelay = 0.15  -- Delay between Animation and Hit
}

-- // 3. HELPER FUNCTIONS (From your snippet) // --

-- Helper: Find the Client Model HP
local function GetClientHealth(serverNPC)
    local serverRoot = serverNPC:FindFirstChild("HumanoidRootPart") or serverNPC.PrimaryPart
    if not serverRoot then return 0 end 

    local clientFolder = Workspace:FindFirstChild("Characters") and Workspace.Characters:FindFirstChild("Client")
    if not clientFolder then return 100 end 

    -- Find the Client Model that is closest to this Server NPC
    local closestClientModel = nil
    local closestDist = 5 

    for _, model in pairs(clientFolder:GetChildren()) do
        if model:IsA("Model") then
            local root = model:FindFirstChild("HumanoidRootPart") or model.PrimaryPart
            if root then
                local dist = (root.Position - serverRoot.Position).Magnitude
                if dist < closestDist then
                    closestDist = dist
                    closestClientModel = model
                end
            end
        end
    end

    if closestClientModel then
        local bg = closestClientModel:FindFirstChild("BillboardGui")
        if bg then
            local frame = bg:FindFirstChild("Frame")
            if frame then
                local label = frame:FindFirstChild("TextLabel")
                if label then
                    local text = label.Text 
                    local split = string.split(text, "/")
                    local current = tonumber(split[1])
                    if current then
                        return current
                    end
                end
            end
        end
    end

    return 100 
end

-- Helper: Find Your Server Character
local function GetMyServerCharacter()
    local myClientChar = nil
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        myClientChar = LocalPlayer.Character
    else
        local clientFolder = Workspace:FindFirstChild("Characters") and Workspace.Characters:FindFirstChild("Client")
        if clientFolder then
            for _, v in pairs(clientFolder:GetChildren()) do
                if string.find(v.Name, LocalPlayer.Name) and v:FindFirstChild("HumanoidRootPart") then
                    myClientChar = v
                    break
                end
            end
        end
    end

    if not myClientChar then return nil end
    local myPos = myClientChar.HumanoidRootPart.Position

    local serverPlayers = Workspace:WaitForChild("Characters"):WaitForChild("Server"):WaitForChild("Players")
    for _, model in pairs(serverPlayers:GetChildren()) do
        if model:IsA("Model") and model:FindFirstChild("HumanoidRootPart") then
            local dist = (model.HumanoidRootPart.Position - myPos).Magnitude
            if dist < 5 then 
                return model
            end
        end
    end
    return nil
end

local function GetMyClientCharacter()
    local clientFolder = Workspace:FindFirstChild("Characters") and Workspace.Characters:FindFirstChild("Client")
    if clientFolder then
        for _, v in pairs(clientFolder:GetChildren()) do
            if string.find(v.Name, LocalPlayer.Name) then return v end
        end
    end
    return LocalPlayer.Character 
end

-- Helper: Get ALL Targets in Range
local function GetTargets(myRootPos)
    local npcsFolder = Workspace:WaitForChild("Characters"):WaitForChild("Server"):FindFirstChild("NPCs")
    if not npcsFolder then return {} end

    local targets = {}

    for _, npc in pairs(npcsFolder:GetChildren()) do
        if npc:IsA("Model") then
            local root = npc:FindFirstChild("HumanoidRootPart") or npc.PrimaryPart
            if root then
                -- Check Distance
                local dist = (root.Position - myRootPos).Magnitude
                
                if dist <= CONFIG.Range then
                    -- Check Health
                    if GetClientHealth(npc) > 0 then
                        table.insert(targets, npc)
                    end
                end
            end
        end
    end
    return targets
end

-- // 4. FEATURE LOOPS // --

-- MAIN AURA LOOP (UPDATED WITH YOUR LOGIC)
local function StartAuraLoop()
    task.spawn(function()
        while AuraEnabled do
            local success, err = pcall(function()
                local myServerChar = GetMyServerCharacter()
                if not myServerChar then 
                    task.wait(0.5)
                    return 
                end

                local myRoot = myServerChar:FindFirstChild("HumanoidRootPart") or myServerChar.PrimaryPart
                if not myRoot then return end

                -- Get all valid enemies
                local targetList = GetTargets(myRoot.Position)
                
                if #targetList > 0 then
                    
                    -- Find closest enemy just to calculate facing direction (Makes it look legit)
                    local closestEnemy = targetList[1]
                    local closestDist = 999
                    
                    for _, enemy in pairs(targetList) do
                        local r = enemy:FindFirstChild("HumanoidRootPart")
                        if r then
                            local d = (r.Position - myRoot.Position).Magnitude
                            if d < closestDist then
                                closestDist = d
                                closestEnemy = enemy
                            end
                        end
                    end

                    local closestRoot = closestEnemy and closestEnemy:FindFirstChild("HumanoidRootPart")
                    
                    if closestRoot then
                        -- A. START SKILL (Visuals)
                        local dir = (closestRoot.Position - myRoot.Position).Unit
                        local vecArg = Vector3.new(dir.X, 0, dir.Z)

                        StartSkillMethod:InvokeServer(unpack({
                            "Punch",
                            myServerChar,
                            vecArg,
                            1,
                            1
                        }))

                        -- B. WAIT
                        task.wait(CONFIG.RegisterDelay)

                        -- C. DAMAGE (Filter list again for alive enemies)
                        local finalTargets = {}
                        for _, enemy in pairs(targetList) do
                            if GetClientHealth(enemy) > 0 then
                                table.insert(finalTargets, enemy)
                            end
                        end

                        if #finalTargets > 0 then
                            local windowID = myServerChar.Name .. "_Punch"
                            
                            -- Use our own position as origin so the AOE spreads from us
                            local spoofedCFrame = myRoot.CFrame 

                            local damageData = {
                                ["SkillID"] = "Punch",
                                ["WindowID"] = windowID,
                                ["LocalCharacter"] = myServerChar,
                                ["Origin"] = spoofedCFrame, 
                                ["CanParry"] = true,
                                ["Parries"] = {}
                            }

                            -- Send the TABLE of targets (AOE)
                            DamageMethod:InvokeServer(unpack({
                                finalTargets, -- Pass the list of all enemies
                                true,
                                damageData
                            }))
                        end
                    end
                end
            end)

            if not success then warn("Aura Error:", err) end
            task.wait(CONFIG.HitDelay)
        end
    end)
end

-- UNLOCK TP LOOP
local function StartUnlockTPLoop()
    task.spawn(function()
        local tpFolder = workspace:FindFirstChild("Map") and workspace.Map:FindFirstChild("Geometry") and workspace.Map.Geometry:FindFirstChild("TeleportPoints")
        if not tpFolder then return warn("Teleport Points folder not found!") end
        local points = tpFolder:GetChildren()
        table.sort(points, function(a, b) return a.Name < b.Name end)
        print("Starting TP Unlock Sequence...")
        for _, tpModel in ipairs(points) do
            if not UnlockTPEnabled then break end
            local targetPart = tpModel:FindFirstChild("TPPart")
            if targetPart then
                local dest = targetPart.CFrame
                local clientChar = GetMyClientCharacter()
                local serverChar = GetMyServerCharacter()
                if clientChar then clientChar:PivotTo(dest) end
                if serverChar then serverChar:PivotTo(dest) end
                task.wait(0.5)
                if UnlockTPEnabled then
                    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.F, false, game)
                    task.wait(0.05)
                    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.F, false, game)
                    print("Unlocked: " .. tpModel.Name)
                end
                task.wait(2.0)
            end
        end
    end)
end

-- AUTO CRATE
local function CheckAndOpenCrate(crate)
    if not AutoCrateEnabled then return end
    task.spawn(function()
        local prompt = crate:WaitForChild("ProximityPrompt", 5)
        if prompt and AutoCrateEnabled then
            local crateName = crate.Name
            local args = { crateName }
            print("Opening Crate: " .. crateName)
            CrateRemote:InvokeServer(unpack(args))
        end
    end)
end

local function StartAutoCrates()
    local cratesFolder = Workspace:WaitForChild("Map"):WaitForChild("Crates")
    for _, child in pairs(cratesFolder:GetChildren()) do
        CheckAndOpenCrate(child)
    end
    if CrateConnection then CrateConnection:Disconnect() end
    CrateConnection = cratesFolder.ChildAdded:Connect(function(child)
        CheckAndOpenCrate(child)
    end)
end

local function StopAutoCrates()
    if CrateConnection then 
        CrateConnection:Disconnect()
        CrateConnection = nil
    end
end

-- // 5. UI CONTROLS // --

CombatTab:Toggle({
    Title = "Kill Aura (Multi-Target)",
    Value = false,
    Callback = function(state) 
        AuraEnabled = state
        if state then StartAuraLoop() end
    end
})

MiscTab:Toggle({
    Title = "Unlock All Teleports",
    Value = false,
    Callback = function(state)
        UnlockTPEnabled = state
        if state then StartUnlockTPLoop() end
    end
})

MiscTab:Toggle({
    Title = "Auto Open Crates",
    Value = false,
    Callback = function(state)
        AutoCrateEnabled = state
        if state then
            StartAutoCrates()
        else
            StopAutoCrates()
        end
    end
})
