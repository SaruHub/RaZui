local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

-- // Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualUser = game:GetService("VirtualUser")
local VirtualInputManager = game:GetService("VirtualInputManager") 
local RunService = game:GetService("RunService")

-- // Constants & Variables
local LocalPlayer = Players.LocalPlayer
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local ClickRemote = Remotes:WaitForChild("Clicked")
local MagicRemote = Remotes:WaitForChild("MagicAttack")
local RaidReplayRemote = Remotes:WaitForChild("Raids"):WaitForChild("Replay")
local EnemiesFolder = Workspace:WaitForChild("Enemies")

-- // Settings
getgenv().AutoClick = false
getgenv().AutoMagic = false 
getgenv().AutoRaid = false  
getgenv().AutoReplay = false
getgenv().AntiAfk = false
getgenv().AutoCastSkills = false
getgenv().SelectedSkills = {} 

local CONST_RANGE = 2000 
local TP_MIN_DISTANCE = 50 
local ATTACK_DELAY = 0.1 
local SkillDebounce = {} -- Prevents spamming the same key

-- // Helper: Check if enemy is alive
local function isEnemyAlive(model)
    if not model or not model.Parent or not model:FindFirstChild("HumanoidRootPart") then return false end

    local hpLabel = nil
    if model:FindFirstChild("HealthBar") and model.HealthBar:FindFirstChild("HPBar") and model.HealthBar.HPBar:FindFirstChild("TextLabel") then
        hpLabel = model.HealthBar.HPBar.TextLabel
    elseif model:FindFirstChild("BossHealthBar") and model.BossHealthBar:FindFirstChild("HPBar") and model.BossHealthBar.HPBar:FindFirstChild("TextLabel") then
        hpLabel = model.BossHealthBar.HPBar.TextLabel
    end

    if hpLabel and hpLabel.Text then
        local text = hpLabel.Text 
        local split = text:split("/")
        
        if split[1] then
            local currentHP = split[1] 
            if currentHP == "0" or currentHP == "Dead" or currentHP == "0M" or currentHP == "0B" then
                return false
            end
            return true 
        end
    end
    return true 
end

-- // Helper: Get Closest Enemy
local function getClosestEnemy(mode)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return nil end
    
    local myRoot = character.HumanoidRootPart
    local closestEnemy = nil
    local shortestDistance = CONST_RANGE

    for _, folder in pairs(EnemiesFolder:GetChildren()) do
        if folder:IsA("Folder") then
            local isUUID = string.len(folder.Name) > 30 
            
            local shouldScan = false
            if mode == "Raid" and isUUID then shouldScan = true end
            if mode == "Normal" and not isUUID then shouldScan = true end

            if shouldScan then
                for _, mob in pairs(folder:GetChildren()) do
                    if mob:IsA("Model") then
                        if isEnemyAlive(mob) then
                            local dist = (mob.HumanoidRootPart.Position - myRoot.Position).Magnitude
                            if dist < shortestDistance then
                                shortestDistance = dist
                                closestEnemy = mob
                            end
                        end
                    end
                end
            end
        end
    end
    
    return closestEnemy
end

-- // Helper: Check Skill Cooldown
local function isSkillReady(slotKey)
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if playerGui and playerGui:FindFirstChild("MainHUD") then
        local hotbar = playerGui.MainHUD.BottomPanel.Hotbar
        local slotName = tostring(slotKey)
        
        if hotbar:FindFirstChild(slotName) then
            local frame = hotbar[slotName]:FindFirstChild("Frame")
            if frame then
                local cd = frame:FindFirstChild("OnCooldown")
                
                -- Check internal debounce first
                if SkillDebounce[slotName] and (os.clock() - SkillDebounce[slotName] < 1.5) then
                    return false
                end

                -- If the Cooldown Frame is missing or invisible, it's ready
                if not cd or cd.Visible == false or cd.BackgroundTransparency == 1 then
                    return true
                end
            end
        end
    end
    return false
end

-- // Helper: Cast Skill
local function castSkill(slotKey)
    local slotString = tostring(slotKey)
    
    -- Register debounce immediately so we don't try again for 1.5 seconds
    SkillDebounce[slotString] = os.clock()

    local key
    if slotString == "1" then key = Enum.KeyCode.One
    elseif slotString == "2" then key = Enum.KeyCode.Two
    elseif slotString == "3" then key = Enum.KeyCode.Three
    elseif slotString == "4" then key = Enum.KeyCode.Four
    elseif slotString == "5" then key = Enum.KeyCode.Five end
    
    if key then
        print("[RaZui] Casting Skill:", slotString) -- DEBUG PRINT
        VirtualInputManager:SendKeyEvent(true, key, false, game)
        task.wait(0.15) -- Hold key longer
        VirtualInputManager:SendKeyEvent(false, key, false, game)
    end
end

-- // Helper: Attack Function
local function attackTarget(target)
    pcall(function()
        local character = LocalPlayer.Character
        if not character or not character:FindFirstChild("HumanoidRootPart") then return end
        if not target or not target:FindFirstChild("HumanoidRootPart") then return end

        local myRoot = character.HumanoidRootPart
        local enemyRoot = target.HumanoidRootPart
        local dist = (enemyRoot.Position - myRoot.Position).Magnitude
        
        local args = {
            [1] = target,            
            [2] = enemyRoot.CFrame,  
            [3] = myRoot.CFrame,     
            [4] = dist               
        }
        
        MagicRemote:FireServer(unpack(args))
    end)
end

-- // Loop 1: Auto Click
task.spawn(function()
    while true do
        task.wait(ATTACK_DELAY)
        if getgenv().AutoClick then
            pcall(function() ClickRemote:FireServer() end)
        end
    end
end)

-- // Loop 2: Auto Farm World
task.spawn(function()
    while true do
        task.wait(ATTACK_DELAY)
        if getgenv().AutoMagic then
            local target = getClosestEnemy("Normal")
            if target then attackTarget(target) end
        end
    end
end)

-- // Loop 3: Auto Farm Raid (Attack + Skills + TP)
task.spawn(function()
    while true do
        task.wait() -- Fast loop
        if getgenv().AutoRaid then
            local target = getClosestEnemy("Raid")
            
            if target then
                local enemyRoot = target:FindFirstChild("HumanoidRootPart")
                
                -- LOCK ON LOOP
                while target and target.Parent and isEnemyAlive(target) do
                    if not getgenv().AutoRaid then break end 

                    local character = LocalPlayer.Character
                    if character and character:FindFirstChild("HumanoidRootPart") and enemyRoot then
                        local myRoot = character.HumanoidRootPart
                        local dist = (myRoot.Position - enemyRoot.Position).Magnitude
                        
                        -- 1. Check if we need to cast a skill
                        local skillToCast = nil
                        if getgenv().AutoCastSkills then
                            for _, slot in pairs(getgenv().SelectedSkills) do
                                if isSkillReady(slot) then
                                    skillToCast = slot
                                    break 
                                end
                            end
                        end

                        -- 2. Movement & Cast Logic
                        if skillToCast then
                            -- TELEPORT BEHIND
                            myRoot.CFrame = enemyRoot.CFrame * CFrame.new(0, 0, 5)
                            
                            -- Wait briefly for TP to register on server
                            task.wait(0.2) 
                            
                            -- CAST
                            castSkill(skillToCast)
                            task.wait(0.2) 
                        else
                            -- STANDARD: Only teleport if too far
                            if dist > TP_MIN_DISTANCE then
                                myRoot.CFrame = enemyRoot.CFrame * CFrame.new(0, 0, 5)
                            end
                        end
                        
                        -- 3. Standard Magic Attack
                        if os.clock() % ATTACK_DELAY < 0.02 then
                            attackTarget(target)
                        end
                    end
                    task.wait() 
                end
            end
        else
            task.wait(0.5)
        end
    end
end)

-- // Loop 4: Auto Replay Raid
task.spawn(function()
    while true do
        task.wait(1) 
        if getgenv().AutoReplay then
            pcall(function()
                local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
                if playerGui and playerGui:FindFirstChild("Raids") and playerGui.Raids:FindFirstChild("Complete") then
                    if playerGui.Raids.Complete.Visible == true then
                        RaidReplayRemote:FireServer(true)
                        task.wait(2) 
                    end
                end
            end)
        end
    end
end)

-- // ANTI-AFK (ScrollLock)
task.spawn(function()
    while true do
        task.wait(60) 
        if getgenv().AntiAfk then
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.ScrollLock, false, game)
            task.wait(0.1)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.ScrollLock, false, game)
        end
    end
end)

-- // UI CREATION
local Window = WindUI:CreateWindow({
    Title = "RaZui Hub",
    Folder = "MySuperHub",
    Size = UDim2.fromOffset(580, 460),
    MinSize = Vector2.new(560, 350),
    MaxSize = Vector2.new(850, 560),
    Transparent = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 150,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = false,
})

Window:SetToggleKey(Enum.KeyCode.K)
Window:EditOpenButton({
    Title = "Open UI",
    CornerRadius = UDim.new(0,16),
    StrokeThickness = 2,
    Color = ColorSequence.new(Color3.fromHex("FF0F7B"), Color3.fromHex("F89B29")),
    OnlyMobile = false,
    Enabled = true,
    Draggable = true,
})

local MainTab = Window:Tab({ Title = "Main Farm" })
MainTab:Select()

local CombatSection = MainTab:Section({ Title = "Main Combat", TextXAlignment = "Left" })

local ToggleClick = CombatSection:Toggle({
    Title = "Auto Click",
    Desc = "Spams the click remote",
    Callback = function(state) 
        getgenv().AutoClick = state
    end
})

local ToggleMagic = CombatSection:Toggle({
    Title = "Auto Farm World",
    Desc = "Attacks normal world enemies",
    Callback = function(state) 
        getgenv().AutoMagic = state
    end
})

local RaidSection = MainTab:Section({ Title = "Raid", TextXAlignment = "Left" })

local ToggleRaid = RaidSection:Toggle({
    Title = "Auto Farm Raid",
    Desc = "Attacks enemies (TPs if > 50 studs)",
    Callback = function(state) 
        getgenv().AutoRaid = state
    end
})

local SkillDropdown = RaidSection:Dropdown({
    Title = "Select Skills to Auto Cast",
    Desc = "Only used during Auto Farm Raid",
    Values = { "1", "2", "3", "4", "5" },
    Value = {},
    Multi = true,
    AllowNone = true,
    Callback = function(option) 
        getgenv().SelectedSkills = option
    end
})

local ToggleSkills = RaidSection:Toggle({
    Title = "Auto Cast Skills",
    Desc = "TPs behind enemy & casts selected skills",
    Callback = function(state) 
        getgenv().AutoCastSkills = state
    end
})

local ToggleReplay = RaidSection:Toggle({
    Title = "Auto Replay Raid",
    Desc = "Replays when 'Complete' UI appears",
    Callback = function(state) 
        getgenv().AutoReplay = state
    end
})

local MiscSection = MainTab:Section({ Title = "Misc", TextXAlignment = "Left" })

local ToggleAFK = MiscSection:Toggle({
    Title = "Anti-AFK",
    Desc = "Prevents you from being kicked for idle",
    Callback = function(state) 
        getgenv().AntiAfk = state
        if state then
            WindUI:Notify({
                Title = "Anti-AFK",
                Content = "Enabled (Spams ScrollLock)",
                Duration = 3,
            })
        end
    end
})
